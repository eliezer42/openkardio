#include "lpfilter.h"

#include <stdlib.h> // For malloc/free
#include <string.h> // For memset

float lpfilter_coefficients[448] = 
{
    -0.000000467530889470, -0.000002934639024242, -0.000004618254723012, -0.000000798799888239, -0.000002201933168424, 0.000000106157152108, 0.000001251939681222, 0.000002856927289379, 0.000003701479170367, 0.000003780913985214, 0.000002875048099123, 0.000001186902831799, -0.000000880344768809, -0.000002747470497107, -0.000003839631221958, -0.000003760806958238, -0.000002438391065593, -0.000000185552177851, 0.000002351727002278, 0.000004355672886188, 0.000005074541021180, 0.000004068598720400, 0.000001390270464766, -0.000002365642800749, -0.000006174826036826, -0.000008849663872776, -0.000009379706225297, -0.000007267017689275, -0.000002738123114416, 0.000003233218978660, 0.000009127606392231, 0.000013263606277815, 0.000014288934765942, 0.000011607385152679, 0.000005636362736067, -0.000002222068879153, -0.000009894114766130, -0.000015181215691187, -0.000016399691488775, -0.000012931256914069, -0.000005489419306619, 0.000003974114806322, 0.000012740186729314, 0.000018065609229435, 0.000018015308077159, 0.000012112144932324, 0.000001608878317403, -0.000010718443332515, -0.000021257918504872, -0.000026581584178162, -0.000024474616111139, -0.000014715775577419, 0.000000659768069896, 0.000017749791669147, 0.000031766991472593, 0.000038341002880887, 0.000034860908604499, 0.000021393008013850, 0.000000890222358765, -0.000021406792975922, -0.000039299194419801, -0.000047355383294880, -0.000042539455093913, -0.000025318888858809, 0.000000202584635492, 0.000027185386004817, 0.000047802117382963, 0.000055467669974596, 0.000046869150463246, 0.000023211780416261, -0.000009731310859562, -0.000042913003379589, -0.000066356488731662, -0.000072030899141192, -0.000056353199789478, -0.000021705681887702, 0.000023681640812244, 0.000067558406939385, 0.000096775158626032, 0.000101055166611626, 0.000076249354896070, 0.000026221627548867, -0.000037381821009367, -0.000097604130504633, -0.000136439696024891, -0.000139858129005021, -0.000102334275897493, -0.000029466275888720, 0.000062092456661402, 0.000147874634793042, 0.000201327081541154, 0.000200962231786868, 0.000137137037359510, 0.000016739583783443, -0.000135639425295608, -0.000280745837513075, -0.000371596873559392, -0.000363120273368145, -0.000222503585672396, 0.000061957737612573, 0.000475598426348701, 0.000977029206532082, 0.001503092528139003, 0.001978309981731004, 0.002327128390984320, 0.002486613040436199, 0.002417180642121574, 0.002109358844410852, 0.001585450141656135, 0.000895954516817531, 0.000111730183214024, -0.000686452013870195, -0.001418877390978030, -0.002016465374737005, -0.002427516589664544, -0.002621020661285258, -0.002586660078581822, -0.002332407668202735, -0.001880875634899911, -0.001265640246875366, -0.000691193755887292, -0.000203341729570806, 0.001074646799452748, 0.001794334640948115, 0.002643760756403643, 0.003278082230592665, 0.003689092468158837, 0.003766864246486890, 0.003470083159860823, 0.002790940639769868, 0.001779645894196775, 0.000536371745895984, -0.000801347606321240, -0.002081517073971137, -0.003164087570695149, -0.003943994820968558, -0.004365397242258578, -0.004423484317368101, -0.004154044131697059, -0.003614330799355719, -0.002861996382926168, -0.001939059040707180, -0.000867083761107496, 0.000344311901789993, 0.001677720300201432, 0.003083938531172508, 0.004463623838712702, 0.005662846227524760, 0.006488474264557077, 0.006742968608967262, 0.006271373204765187, 0.005011169294969216, 0.003027641537447130, 0.000523940476265998, -0.002182284174138229, -0.004711999988495104, -0.006698153010876754, -0.007861904337568186, -0.008073039351611437, -0.007374531970642664, -0.005965932995924093, -0.004148014559858018, -0.002243231858073336, -0.000511496654737600, 0.000911403237524139, 0.002034074827461683, 0.002983104572977992, 0.003936361123115516, 0.005031696868489316, 0.006285649062681377, 0.007547199838059730, 0.008505608478791119, 0.008758525052342373, 0.007928644067122360, 0.005791779225100766, 0.002386563916952212, -0.001935365589988268, -0.006542595201233544, -0.010636771877223611, -0.013426825939219459, -0.014323257208464158, -0.013094926403190555, -0.009949499784362268, -0.005504470657904880, -0.000648341956304205, 0.003671058351018805, 0.006686802874625039, 0.008007279622913562, 0.007713336008887532, 0.006325759974270472, 0.004639973158673398, 0.003479669561380181, 0.003423364162358097, 0.004597727493386394, 0.006594025367971919, 0.008549744975542003, 0.009384197879608539, 0.008129223991372355, 0.004272903524698470, -0.001995122776501677, -0.009708770712860094, -0.017275035451590332, -0.022820443330466293, -0.024669146684253764, -0.021827033258360707, -0.014343930526910700, -0.003435922270450187, 0.008681482901513226, 0.019269349503246703, 0.025678630756263324, 0.026080904793933164, 0.020016075770312114, 0.008675373131895855, -0.005198985648897514, -0.017805193422632294, -0.025075332227089353, -0.023603534584542254, -0.011498910645538608, 0.011044992948502724, 0.041610176367117835, 0.075900849078222282, 0.108520679898752082, 0.134021636957136064, 0.147999999999999993, 0.148000000000000048, 0.134021636957136120, 0.108520679898752082, 0.075900849078222282, 0.041610176367117835, 0.011044992948502724, -0.011498910645538606, -0.023603534584542264, -0.025075332227089360, -0.017805193422632291, -0.005198985648897507, 0.008675373131895852, 0.020016075770312117, 0.026080904793933157, 0.025678630756263327, 0.019269349503246703, 0.008681482901513217, -0.003435922270450185, -0.014343930526910700, -0.021827033258360704, -0.024669146684253764, -0.022820443330466299, -0.017275035451590343, -0.009708770712860091, -0.001995122776501678, 0.004272903524698469, 0.008129223991372355, 0.009384197879608536, 0.008549744975542003, 0.006594025367971919, 0.004597727493386393, 0.003423364162358096, 0.003479669561380181, 0.004639973158673395, 0.006325759974270469, 0.007713336008887532, 0.008007279622913560, 0.006686802874625039, 0.003671058351018803, -0.000648341956304204, -0.005504470657904880, -0.009949499784362272, -0.013094926403190555, -0.014323257208464160, -0.013426825939219454, -0.010636771877223608, -0.006542595201233544, -0.001935365589988268, 0.002386563916952210, 0.005791779225100766, 0.007928644067122362, 0.008758525052342373, 0.008505608478791121, 0.007547199838059730, 0.006285649062681379, 0.005031696868489315, 0.003936361123115515, 0.002983104572977991, 0.002034074827461683, 0.000911403237524140, -0.000511496654737600, -0.002243231858073336, -0.004148014559858018, -0.005965932995924092, -0.007374531970642664, -0.008073039351611437, -0.007861904337568188, -0.006698153010876751, -0.004711999988495102, -0.002182284174138229, 0.000523940476265998, 0.003027641537447130, 0.005011169294969216, 0.006271373204765185, 0.006742968608967262, 0.006488474264557078, 0.005662846227524759, 0.004463623838712702, 0.003083938531172509, 0.001677720300201433, 0.000344311901789993, -0.000867083761107496, -0.001939059040707180, -0.002861996382926168, -0.003614330799355719, -0.004154044131697058, -0.004423484317368101, -0.004365397242258577, -0.003943994820968556, -0.003164087570695149, -0.002081517073971137, -0.000801347606321241, 0.000536371745895984, 0.001779645894196775, 0.002790940639769868, 0.003470083159860824, 0.003766864246486890, 0.003689092468158840, 0.003278082230592664, 0.002643760756403643, 0.001794334640948115, 0.001074646799452748, -0.000203341729570806, -0.000691193755887292, -0.001265640246875366, -0.001880875634899912, -0.002332407668202735, -0.002586660078581822, -0.002621020661285258, -0.002427516589664545, -0.002016465374737005, -0.001418877390978030, -0.000686452013870195, 0.000111730183214024, 0.000895954516817531, 0.001585450141656135, 0.002109358844410852, 0.002417180642121574, 0.002486613040436199, 0.002327128390984319, 0.001978309981731004, 0.001503092528139004, 0.000977029206532081, 0.000475598426348701, 0.000061957737612573, -0.000222503585672396, -0.000363120273368145, -0.000371596873559392, -0.000280745837513075, -0.000135639425295608, 0.000016739583783443, 0.000137137037359510, 0.000200962231786868, 0.000201327081541154, 0.000147874634793042, 0.000062092456661402, -0.000029466275888720, -0.000102334275897493, -0.000139858129005021, -0.000136439696024891, -0.000097604130504633, -0.000037381821009367, 0.000026221627548867, 0.000076249354896070, 0.000101055166611626, 0.000096775158626032, 0.000067558406939385, 0.000023681640812244, -0.000021705681887702, -0.000056353199789478, -0.000072030899141192, -0.000066356488731662, -0.000042913003379589, -0.000009731310859562, 0.000023211780416261, 0.000046869150463246, 0.000055467669974596, 0.000047802117382963, 0.000027185386004817, 0.000000202584635492, -0.000025318888858809, -0.000042539455093913, -0.000047355383294880, -0.000039299194419801, -0.000021406792975922, 0.000000890222358765, 0.000021393008013850, 0.000034860908604499, 0.000038341002880887, 0.000031766991472593, 0.000017749791669147, 0.000000659768069896, -0.000014715775577419, -0.000024474616111139, -0.000026581584178162, -0.000021257918504872, -0.000010718443332515, 0.000001608878317403, 0.000012112144932324, 0.000018015308077159, 0.000018065609229435, 0.000012740186729314, 0.000003974114806322, -0.000005489419306619, -0.000012931256914069, -0.000016399691488775, -0.000015181215691187, -0.000009894114766130, -0.000002222068879153, 0.000005636362736067, 0.000011607385152679, 0.000014288934765942, 0.000013263606277815, 0.000009127606392231, 0.000003233218978660, -0.000002738123114416, -0.000007267017689275, -0.000009379706225297, -0.000008849663872776, -0.000006174826036826, -0.000002365642800749, 0.000001390270464766, 0.000004068598720400, 0.000005074541021180, 0.000004355672886188, 0.000002351727002278, -0.000000185552177851, -0.000002438391065593, -0.000003760806958238, -0.000003839631221958, -0.000002747470497107, -0.000000880344768809, 0.000001186902831799, 0.000002875048099123, 0.000003780913985214, 0.000003701479170367, 0.000002856927289379, 0.000001251939681222, 0.000000106157152108, -0.000002201933168424, -0.000000798799888239, -0.000004618254723012, -0.000002934639024242, -0.000000467530889470
};


lpfilterType *lpfilter_create( void )
{
    lpfilterType *result = (lpfilterType *)malloc( sizeof( lpfilterType ) ); // Allocate memory for the object
    lpfilter_init( result );                                               // Initialize it
    return result;                                                        // Return the result
}

void lpfilter_destroy( lpfilterType *pObject )
{
    free( pObject );
}

void lpfilter_init( lpfilterType * pThis )
{
    lpfilter_reset( pThis );
}

void lpfilter_reset( lpfilterType * pThis )
{
    memset( &pThis->state, 0, sizeof( pThis->state ) ); // Reset state to 0
    pThis->pointer = pThis->state;                      // History buffer points to start of state buffer
    pThis->output = 0;                                  // Reset output
}

int lpfilter_filterBlock( lpfilterType * pThis, float * pInput, float * pOutput, unsigned int count )
{
    float *pOriginalOutput = pOutput;               // Save original output so we can track the number of samples processed
    float accumulator;

    for( ;count; --count )
    {
        pThis->pointer[lpfilter_length] = *pInput;                   // Copy sample to top of history buffer
        *(pThis->pointer++) = *(pInput++);                         // Copy sample to bottom of history buffer

        if( pThis->pointer >= pThis->state + lpfilter_length )       // Handle wrap-around
            pThis->pointer -= lpfilter_length;

        accumulator = 0;
        lpfilter_dotProduct( pThis->pointer, lpfilter_coefficients, &accumulator, lpfilter_length );

        *(pOutput++) = accumulator;  // Store the result
    }

    return pOutput - pOriginalOutput;
}

void lpfilter_dotProduct( float * pInput, float * pKernel, float * pAccumulator, short count )
{
    float accumulator = *pAccumulator;
    while( count-- )
        accumulator += ((float)*(pKernel++)) * *(pInput++);
    *pAccumulator = accumulator;
}


