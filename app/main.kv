#:kivy 2.2.0
#:include kv/exam.kv
#:include kv/navdrawer.kv
#:include kv/okwidgets.kv
#:include kv/patient.kv
#:include kv/toolbarscreen.kv

MDNavigationLayout:
         
    ScreenManager:
        id: screen_manager
            
        ToolbarScreen:
            name: "homescreen"
            title: "Inicio"
            action_items: [['menu', lambda x: app.root.ids.nav_drawer.set_state("open")]]
            right_items: [['refresh-circle',lambda _: app.refresh_home()]]
            on_enter: app.populate_start()

            Image:
                source: 'assets/imagotipo.png'
                size: self.texture_size
                fit_mode: "contain"
                size_hint: 1, 0.15
            MDLabel:
                id: info
                halign: "center"
                font_style: "Subtitle2"
                size_hint: 1, 0.07
                canvas.before:
                    Color:
                        rgba: .85,.83,.9,.9
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [dp(16)]

            SummaryCard:
                id: start_exams
                icon: "clipboard-text-outline"
                text: "Exámenes"
                label: "Realizados"
                size_hint: 1, 0.38
                
            SummaryCard:
                id: start_patients
                icon: "account-group"
                text: "Pacientes"
                label: "Registrados"
                size_hint: 1, 0.32
                
            MDLabel:
                text: "Universidad Nacional de Ingeniería"
                bold: True
                halign: "center"
                font_style: "H5"
                color: "grey"
                size_hint: 1, 0.05

            MDLabel:
                text: "Nicaragua, 2023"
                halign: "center"
                font_style: "H6"
                color: "grey"
                size_hint: 1, 0.03


            

        ToolbarScreen:
            name: "ekg_list_view"
            title: "Exámenes"
            action_items: [['menu', lambda x: app.root.ids.nav_drawer.set_state("open")]]
            right_items: [['plus-box', lambda _: app.go_to("select_patient_view")],['refresh-circle',lambda _: app.download_cases()]]
            on_enter:
                app.root.ids.pending.badge_icon = app.root.ids.exam_pending_list.populate("",False,False)
                app.root.ids.done.badge_icon = app.root.ids.exam_done_list.populate("",False,True)

            MDBottomNavigation:

                MDBottomNavigationItem:
                    id: pending
                    name: 'screen 1'
                    text: 'Pendiente'
                    icon: 'inbox-full'

                    ExamList:
                        id: exam_pending_list
                
                MDBottomNavigationItem:
                    id: done
                    name: 'screen 2'
                    text: 'Diagnosticado'
                    icon: 'check-bold'

                    ExamList:
                        id: exam_done_list


        ToolbarScreen:
            name: "ekg_detail_view"
            right_items: [['delete',lambda x: app.delete_exam(self.object_id)],['send', lambda x: app.send_exam(self.object_id)]]
            action_items: [['arrow-left', lambda *args : app.go_back("ekg_list_view")]]
            on_pre_enter:
                app.root.ids.ekg_plot.reset()
            on_enter:
                app.root.ids.ekg_plot.populate(app.root.ids.exam_metadata.populate(self.object_id))
            ExamMetadataDetail:
                id: exam_metadata
                size_hint_y: 0.35
            ScrollView:
                do_scroll_y: False
                effect_cls: 'ScrollEffect'
                Plot:
                    id: ekg_plot
                    size_hint_x: None
                    size_hint_y: None
                    height: self.parent.height
                    width: self.parent.width
            MDBoxLayout:
                orientation:'horizontal'
                size_hint_y: 0.25
                padding: "2dp"
                spacing: "2dp"
                MDLabel:
                    text: "Comentarios:"
                    font_style: "Subtitle2"
                    halign: "right"
                    size_hint_x: 0.3
                    theme_text_color: "Custom"
                    text_color: 0, 0, 0.9, 1
                MDLabel:
                    id: notes
                    md_bg_color: 1,1,1,0.94
            MDBoxLayout:
                orientation:'horizontal'
                size_hint_y: 0.25
                padding: "2dp"
                spacing: "2dp"
                MDLabel:
                    text: "Diagnóstico:"
                    font_style: "Subtitle2"
                    halign: "right"
                    size_hint_x: 0.3
                    theme_text_color: "Custom"
                    text_color: 0.1, 0.7, 0.1, 1
                MDLabel:
                    id: diagnostic
                    md_bg_color: 1,1,1,0.94


        ToolbarScreen:
            name: "select_patient_view"
            title: "Seleccione el paciente"
            action_items: [['arrow-left', lambda *args : app.go_back("ekg_list_view")]]
            on_enter: app.root.ids.patient_selector.populate()
            PatientSelector:
                id: patient_selector


        ToolbarScreen:
            name: "ekg_create_view"
            title: "Nuevo EKG"
            action_items: [['arrow-left', lambda *args : app.go_back("ekg_list_view")]]
            right_items: [['content-save', lambda _: app.save_exam()],['autorenew',lambda _: app.root.ids.new_ekg.reset()]]
            on_pre_enter:
                app.root.ids.new_exam_metadata.populate(self.object_id)
                app.root.ids.new_ekg.reset()
                app.root.ids.ok_device_panel.duration = 10
            ExamMetadataForm:
                id: new_exam_metadata
            ScrollView:
                do_scroll_y: False
                effect_cls: 'ScrollEffect'
                Plot:
                    id: new_ekg
                    size_hint_x: None
                    size_hint_y: None
                    height: self.parent.height
                    width: self.parent.width
                    sample_rate: app.ble.sample_rate
            OKDevicePanel:
                id: ok_device_panel
                sample_rate: app.ble.sample_rate
                leads: app.ble.lead_count
                battery: app.ble.battery_level
                resolution: app.ble.resolution
                fw_version: app.ble.fw_version
                ble_state: app.ble.state

        ToolbarScreen:
            name: "patient_list_view"
            title: "Pacientes"
            action_items: [['menu', lambda x: app.root.ids.nav_drawer.set_state("open")]]
            right_items: [['plus-box', lambda _: app.go_to("patient_create_view")]]
            on_enter: app.root.ids.patient_list.populate()
            ScrollView:
                PatientList:
                    id: patient_list


        ToolbarScreen:
            name: "patient_detail_view"
            title: "View Patient"
            action_items: [['arrow-left', lambda _ : app.go_back("patient_list_view")]]
            right_items: [['delete', lambda _: app.delete_patient(self.object_id)]]
            on_pre_enter: app.root.ids.patient_detail.populate(self.object_id)
            PatientDetail:
                id: patient_detail


        ToolbarScreen:
            name: "patient_create_view"
            title: "Nuevo paciente"
            action_items: [['arrow-left', lambda *args : app.go_back("patient_list_view")]]
            on_enter: app.root.ids.patient_form.clear_fields()
            ScrollView:
                PatientForm:
                    id: patient_form


        ToolbarScreen:
            name: "config"
            title: "Configuración"
            action_items: [['menu', lambda x: app.root.ids.nav_drawer.set_state("open")]]
            right_items: [['refresh-circle',lambda _: app.populate_hospitals()]]
            on_enter:
                uid.ids.text_field.text = app.store['user']['id']
                mode_control.populate()
                filter_control.populate()
            MDLabel:
                text: "ID de Usuario"
                font_style: "H6"
                halign: "center"
            OKIdTextField:
                id: uid
                md_bg_color: .8,.8,.9,.9 
            MDLabel:
                text: "Modo de uso de la Aplicación"
                font_style: "H6"
                halign: "center"
            OKModeControl:
                id: mode_control
                md_bg_color: .8,.8,.9,.9
            MDLabel:
                text: "Filtro digital (Hardware)"
                font_style: "H6"
                halign: "center"
            OKFilterControl:
                id: filter_control
                md_bg_color: .8,.8,.9,.9
            Widget:


        ToolbarScreen:
            name: "help"
            title: "Ayuda"
            action_items: [['menu', lambda x: app.root.ids.nav_drawer.set_state("open")]]
            ScrollView:
                size:self.size
                GridLayout:
                    cols:1
                    size_hint:1,None
                    padding:"10dp"
                    spacing:"10dp"
                    height:self.minimum_height
                    width:self.minimum_width
                    MDLabel:
                        text:"Guía rápida"
                        font_style:"H5"
                        size_hint: 1,None
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"[color=#d35f5f][b]Open[/b][/color][color=#5f99d3][b]Kardio[/b][/color] es una plataforma de electrocardiografía digital que permite la toma exámenes cardíacos y el envío de estos a través de Internet para que sean evaluados de forma remota por un especialista, de tal forma que los pacientes no se vean en la necesidad de desplazarse mas alla de su centro de salud local para descartar padecimientos cardíacos."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"El sistema esta compuesto por [b](a)[/b] una aplicacion disponible para dispositivos móviles Android y escritorios Windows; [b](b)[/b] un dispositivo electrónico que captura la señal electrocardiográfica y la envía a través de Bluetooth Low Energy (BLE); y [b](c)[/b] un servicio en la nube que actúa como backend de la solución."
                    Image:
                        source: 'assets/diagram1.png'
                        size: self.texture_size
                        fit_mode: "contain"
                        size_hint: 1,None
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"La presente aplicación está estructurada en las siguientes secciones:\n    [b]Inicio[/b]\n    [b]Examenes[/b]\n    [b]Pacientes[/b]\n    [b]Configuracion[/b]\n    [b]Ayuda[/b]"
                    MDLabel:
                        text:"Instrucciones de Uso"
                        font_style:"H5"
                        size_hint: 1,None
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"1. Encienda el electrocardiógrafo [b]OpenKardio[/b]."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"2.Conecte el cable de electrodos al electrocardiografo."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"3. Coloque los electrodos al paciente segun la imagen y conecte los extremos del cable a cada electrodo segun el codigo de colores."
                    Image:
                        source: 'assets/leads_placement.jpg'
                        size: self.texture_size
                        fit_mode: "contain"
                        size_hint: 1,None
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text: "4. Active el [b]Bluetooth[/b] de este dispositivo."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text: "5. Diríjase a la vista de Exámenes y presione el boton [b]+[/b] para agregar un nuevo examen." 
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text: "6. A continuación elija el paciente para el cual desea registrar un nuevo examen. En caso de ser uno nuevo ingrese los datos del nuevo paciente en la vista de Pacientes, al presionar el botón [b]+[/b]. Por ultimo regrese al paso 5."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text: "7. Una vez en la vista [b]Nuevo EKG[/b] proceda a llenar a los campos de signos vitales y notas. A continuacion presione [b]CONECTAR[/b]. Una vez que este dispositivo se haya conectado al electrocardiografo, puede presionar [b]EMPEZAR[/b] para comenzar a capturar el EKG."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text: "8. En caso de que necesite detener el examen puede presionar [b]DETENER[/b]. Para limpiar la grafica, presione el boton [b]RESET[/b] en la parte superior derecha."
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text: "9. Si la toma del EKG fue satisfactoria, presione enviar, y seleccione un Hospital al cual desee enviar el EKG para su diagnostico."
                    MDLabel:
                        text:"Acerca de"
                        font_style:"H5"
                        size_hint: 1,None
                    MDLabel:
                        markup:True
                        adaptive_height:True
                        size_hint: 1,None
                        text:"[b]OpenKardio v0.1[/b].\nEsta aplicación es de código abierto como parte de un proyecto monográfico de la Universidad Nacional de Ingeniería de Nicaragua. El código fuente está disponible en el repositorio [u]https://github.com/eliezer42/openkardio[/u]. Para soporte escriba al correo openkardio@gmail.com"
                    Image:
                        source: 'assets/uni-mini-logo.png'
                        size: self.texture_size
                        fit_mode: "contain"
                        size_hint: 1,None
                        
    MDNavigationDrawer:
        id: nav_drawer
        ContentNavigationDrawer:
            id: content_drawer